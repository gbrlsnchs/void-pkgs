# Template file for 'deno'
pkgname=deno
version=1.20.1
revision=1
_gn_githash=6f13aaac
archs="x86_64"
create_wrksrc=yes
build_helper="rust"
hostmakedepends="cargo pkg-config curl unzip python3 ninja clang nodejs
 lld llvm gobject-introspection"
depends="libglib-devel"
short_desc="Simple, modern and secure runtime for JavaScript and TypeScript"
maintainer="shizonic <realtiaz@gmail.com>"
license="MIT"
homepage="https://deno.land"
distfiles="https://github.com/denoland/deno/archive/v${version}.tar.gz
https://gn.googlesource.com/gn/+archive/${_gn_githash}.tar.gz"
checksum="c5d0dc71dfa300ce14a8057fd4c0d16b86e963fff34c48ea28782521ce1144fc
 cdce461c3fdcb6d61b4a9c9b79b5caf1491d1ac93d4d270bc41101c1e3c41536"

post_extract() {
	printf '#define LAST_COMMIT_POSITION "%s"\n' "${_gn_githash}" >src/gn/last_commit_position.h
	printf '#define LAST_COMMIT_POSITION_NUM 0\n' >>src/gn/last_commit_position.h
}

pre_build() {
	./build/gen.py --no-last-commit-position
	ninja -C out
	PATH="$(realpath ./out/gn):$PATH"
	export PATH
}

do_build() {
	cd ${pkgname}-${version}
	CLANG_BASE_PATH=/usr \
	NINJA=/usr/bin/ninja \
	GN=$(realpath ../out/gn) \
	V8_FROM_SOURCE=1 \
	cargo build --release --locked --target ${RUST_TARGET} -vv
}

do_install() {
	vbin ${pkgname}-${version}/target/${RUST_TARGET}/release/deno
	vlicense ${pkgname}-${version}/LICENSE
}
