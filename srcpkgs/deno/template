# Template file for 'deno'
pkgname=deno
version=1.20.4
revision=3
_gn_githash=6f13aaac
archs="x86_64"
create_wrksrc=yes
build_helper="rust"
hostmakedepends="cargo pkg-config curl unzip python3 ninja clang nodejs
 lld llvm gobject-introspection"
depends="libglib-devel"
short_desc="Simple, modern and secure runtime for JavaScript and TypeScript"
maintainer="shizonic <realtiaz@gmail.com>"
license="MIT"
homepage="https://deno.land"
distfiles="https://github.com/denoland/deno/archive/v${version}.tar.gz
https://gn.googlesource.com/gn/+archive/${_gn_githash}.tar.gz"
checksum="4e7cd0342830d138caf5deba3138833084fac3ad027837119ad19598453927d8
 @80d9da7d58252fa49089386c943d8e3c493a4e314309dbf5e7b7585bfb484fa8"

post_extract() {
	printf '#define LAST_COMMIT_POSITION "%s"\n' "${_gn_githash}" >src/gn/last_commit_position.h
	printf '#define LAST_COMMIT_POSITION_NUM 0\n' >>src/gn/last_commit_position.h
}

pre_build() {
	./build/gen.py --no-last-commit-position
	ninja -C out
	PATH="$(realpath ./out/gn):$PATH"
	export PATH
}

do_build() {
	cd ${pkgname}-${version}
	CLANG_BASE_PATH=/usr \
	NINJA=/usr/bin/ninja \
	GN=$(realpath ../out/gn) \
	V8_FROM_SOURCE=1 \
	cargo build --release --locked --target ${RUST_TARGET} -vv
}

do_install() {
	vbin ${pkgname}-${version}/target/${RUST_TARGET}/release/deno
	vlicense ${pkgname}-${version}/LICENSE
}
